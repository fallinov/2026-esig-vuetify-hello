# ╔════════════════════════════════════════════════════════════════════════════╗
# ║  WORKFLOW DE PRODUCTION — Déploiement FTP sur Infomaniak                   ║
# ╚════════════════════════════════════════════════════════════════════════════╝
name: Deploy to Production (FTP)

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║  DÉCLENCHEURS — Quand déployer en production ?                             ║
# ╚════════════════════════════════════════════════════════════════════════════╝
on:
  # Déclenchement sur création d'un tag (v1.0.0, v2.1.3, etc.)
  push:
    tags:
      - 'v*.*.*'
  # Déclenchement sur publication d'une release GitHub
  release:
    types: [published]
  # Déclenchement manuel (en cas d'urgence)
  workflow_dispatch:

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║  JOB : Compiler et déployer sur Infomaniak                                 ║
# ╚════════════════════════════════════════════════════════════════════════════╝
jobs:
  deploy-production:
    runs-on: ubuntu-latest
    steps:
      # Étape 1 : Récupérer le code source
      - name: Checkout
        uses: actions/checkout@v4

      # Étape 2 : Installer Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      # Étape 3 : Installer les dépendances
      - name: Install dependencies
        run: npm ci

      # Étape 4 : Compiler l'application pour la production
      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production
          VITE_BASE_URL: ${{ secrets.VITE_BASE_URL_PROD }}

      # Étape 5 : Déployer via FTP sur Infomaniak
      - name: Deploy to Infomaniak FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          local-dir: ./dist/